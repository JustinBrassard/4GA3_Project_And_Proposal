---
title: "Collisions in Relation to School Safety Zones in Toronto"
thanks: Paper submitted to complete the requirements of ENVSOCTY 4GA3 Applied Spatial
  Statistics.
date: "4/9/2021"
output:
  pdf_document:
    template: project-template-default.tex
  html_document:
    df_print: paged
abstract: This paper reports our analysis of motor vehicle collisions in Toronto,
  Canada, and its relationship with the presence of school safety zones. Data were
  obtained from the City of Toronto open data website, as well as the City of Toronto
  Transportation Services department, and 311 Toronto.
keywords: crash, motor vehicle collisions, schools, spatial analysis
authors:
- name: Michel Giese
  student_number: 400010952
- name: Justin Brassard
  student_number: 400181410
- name: Mohammad Ali
  student_number: 400079555
- name: Nathan Walschots
  student_number: 400192318
subject: ENVSOCTY 4GA3
bibliography:
- bibliography.bib
- packages.bib
always_allow_html: yes
---

<!--Chunks of code can have names; the chunk option "include" controls whether the chunk and its output are printed in the final document-->
```{r, warning=FALSE}
library(leaflet.extras)
library(sp)
library(leaflet)
library(tidyverse)
library(gstat)
library(sf)
library(readr)
library(spatstat)
library(maptools)
library(dplyr)
```

```{r write-package-bib, include=FALSE}
# This function is used to write a bibliography for the `R` packages used in the paper
knitr::write_bib(file = 'packages.bib')
```

```{r}
#importing necessary files from GitHub

collisionsfile="https://raw.githubusercontent.com/JustinBrassard/4GA3_Project_And_Proposal/main/data/Motor%20Vehicle%20Collisions/Motor%20Vehicle%20Collisions%20with%20KSI%20Data%20True.csv?token=AS22SR2ZGZO34O7CM56XBFTANDP44"

fullcollisionsfile = "https://raw.githubusercontent.com/JustinBrassard/4GA3_Project_And_Proposal/main/data/Motor%20Vehicle%20Collisions/Full_Collisions.csv"

kidcollisionsfile = "https://raw.githubusercontent.com/JustinBrassard/4GA3_Project_And_Proposal/main/data/Motor%20Vehicle%20Collisions/Kids%20Full%20Collisions%20-%20Motor%20Vehicle%20Collisions%20with%20KSI%20Data.csv"

zonesfile="https://raw.githubusercontent.com/JustinBrassard/4GA3_Project_And_Proposal/main/data/Stationary%20Sign%20locations/Stationary%20Sign%20Locations%20True%20-%20Stationary%20Sign%20locations.csv?token=AS22SR3YXJ3MMPTFKRTZFIDANDQKW"

schoolsfile="https://raw.githubusercontent.com/JustinBrassard/4GA3_Project_And_Proposal/main/data/point-school-locations-wgs84/School%20Locations%20True%20-%20School%20locations-all%20types%20data.csv?token=AS22SR3J4NEF54PS3OOARYTANDQOY"

boundsfile <- "https://raw.githubusercontent.com/JustinBrassard/4GA3_Project_And_Proposal/main/data/Toronto%20Boundary%20Points%20UTM15N/Toronto_Points.csv"


Motor_Vehicle_Collisions_with_KSI_Data_True<-read_csv(url(collisionsfile))
Full_Collisions<-read_csv(url(fullcollisionsfile))
Kid_Collisions<-read_csv(url(kidcollisionsfile))

Stationary_Sign_Locations_True<-read_csv(url(zonesfile))
School_Locations_True<-read_csv(url(schoolsfile))

Toronto_Points<-read_csv(url(boundsfile))
```

```{r}
#separation of 'geometry' column into two lng & lat columns for main data sets
School_Zones <- Stationary_Sign_Locations_True %>%
  separate(geometry, into = c('lng', 'lat'), sep = ', ')
Schools <- School_Locations_True %>%
  separate(geometry, into = c('lng', 'lat'), sep = ', ')

Collisions <- Motor_Vehicle_Collisions_with_KSI_Data_True %>%
  separate(geometry, into = c('lng', 'lat'), sep = ', ')
Full_Collisions <- Full_Collisions %>%
  separate(geometry, into = c('lng', 'lat'), sep = ', ')
Kid_Collisions <- Kid_Collisions %>%
  separate(geometry, into = c('lng', 'lat'), sep = ', ')
```

```{r}
#df to sf conversion of main data sets
School_Zones.sf <- st_as_sf(School_Zones, coords = c("lng", "lat"))
Schools.sf <- st_as_sf(Schools, coords = c("lng", "lat"))

Collisions.sf <- st_as_sf(Collisions, coords = c("lng", "lat"))
```

<!--This format should be used to comment out sections of code/text. Or just use [Shift + Ctrl + C] - MG-->
<!--This creates a page break, i.e., starts a new page-->
<!--\newpage-->

<!-- 
To cite references in your bibliography.bib file, use [@item] if you want it to be cited in brackets, or @item if you want it to be cited as Name (year). If you want to cite various items in brackets, separate them with semicolons [@item1; @item2]
-->

<!--Use "#" for section headers-->
# Introduction

The goal of this project is to explore the relationships between motor vehicle collisions (strictly involving pedestrians), and school safety zones within Toronto. To draw conclusions, data from various sources have been acquired in order to establish trends from previous years. General trends on this relationship were determined before the data were further analyzed. Having an opportunity to examine these data allowed for some rough predictions to be made in terms of the reasons for these incidents occurring more and less frequently within specific areas of Toronto. For instance, the number of collisions in school safety zones should drop where the speed limit is lower. Further analysis is required to determine if this is the case.

This is intended to find ways to reduce these incidents as injury and fatality rates are higher in some areas. If fines can be increased in these areas, along with adding additional traffic enforcement, these incidents may be prevented from occurring in the future. There are likely more conclusions and solutions that will be determined as the data is further analyzed as various other factors will be examined, supplementing this general outlook. Overall, having a better insight on this issue can help generate ideas on how to reduce motor collision incidents within school zones in the City of Toronto.

# Background

Canada has shown an improvement in road and transport safety over the years as collision fatalities and injuries have exhibited a declining trend. Nevertheless, vehicular collisions remain a prominent threat to the lives, bodies, bank accounts, and general well-being of Canadians. In 2018, collisions resulted in 1500 fatalities and 152,847 injuries (Transport Canada, 2020).  “On-road” collisions have been a majority source of child fatalities for many years in Canada, and despite the lowering rate, these collisions comprise  49% of fatalities affecting children aged 0-14 with only 13% of them occurring when the child is a passenger (Parachute, 2016). This outlines that child pedestrians are at risk of being fatally struck by vehicles. To counteract this, school zones are established to protect children in and around areas they frequently gather (i.e. schools). School zones are strips of road near schools or childcare areas, delineated by a lower maximum speed limit and an inability to pass in either lane. These zones have been shown to effectively reduce the number of fatal and injury inducing crashes by ~4% per a 1km/h decrease in speed limit (Sun et al., 2018, p. 1087).

School zones seem to be effective in idealized scenarios but concerns exist due to unequal zone states in which municipalities and drivers are responsible for creating. Municipalities establish school zones and determine their features (location, length, speed limit, etc) and in the end, drivers must make the effort to consciously follow the rules and make safe choices when in a zone. This is not guaranteed: on average in Toronto 21% of drivers speed while in school zones with percentages climbing as high as 85% in specific zones, which road safety advocates blame partially on infrastructure that promotes fast driving (ex. straightaways and four-lane traffic) (Rocha & Pelley, 2020). Speeding alone is not the only threat to school zone safety; illegal parking and distracted driving have both been identified as some of the most common unsafe behaviours demonstrated by drivers in school zones (CAA polling, 2019). If these actions are as common as they are reported to be, then are school zones not uniformly deterring drivers from unsafe behaviours?

In conclusion, school zones are effective, but are they effective unilaterally and are their features optimized for reducing the ever-present threat of collisions for younger generations? This study has value in that it provides a deeper understanding of the efficacy of school zones as it gives insight into the spatial distributions of crashes within them, potentially establishing zones with varying intensities, opposed to taking efficacy averages. Through this, hotspots and trends in school zone contained collisions can be developed, outlining regions that should be addressed.


# Predictions

The research question asks if there is a direct relationship between collisions involving pedestrians and the presence of school safety zones. Due to the proven efficacy of safety zones, it is predicted that these areas will experience fewer collisions than areas without safety zones. Conversely, it is probable that areas that experience more collisions than others will be found to lack adequate safety features.

Several factors may affect the reliability and accuracy of the data analysis conducted. If a safety zone was recently established in an area, it is possible that a significant number of collisions occurred there to necessitate its creation, skewing the number of events in this zone. This is solved by comparing the zone implementation date to the collision event date, both of which are fields present in the collisions shapefile. As well, areas with a higher population density and greater traffic flow are more likely to have collisions. The active hours of a safety zone are also of relevance. Some safety signs are turned off after school hours, raising the speed limit to facilitate greater traffic flow. If collisions occurred at this time, this would give the appearance of greater collisions in a safety zone, when in fact the zone was not active. Fortunately, collision time and zone active hours are recorded in the collision and safety zone shapefiles, respectively, solving this issue. Finally, other roadway conditions play a role in collision frequency, such as lighting, road state (icy, dry, etc.), and visibility. If little correlation is found between safety zones and collisions, perhaps one of these fields will prove more significant.

# Study area

<!-- Talk about the study area. I suppose we're just looking at Toronto.  -->

```{r retrieve-arcos-data, include=FALSE}

```

# Data

<!-- We could probably mostly copy/paste our Data section from the project proposal and tweek the stuff we changed/added. It doesn't need to be very long IMO -->

# Methods

<!-- We can just talk about the tools we're using (q.test, leaflet, heatmaps, etc.) and include a brief reasoning behind each tool (one sentence maximum?) -->

# Results

<!-- This part can be short but we probably can't really write much until we're done all of our analysis  -->

```{r plot-annual-dosage, echo=FALSE, fig.cap={"\\label{fig:annual-dosage}Annual opioid pills per person by county in Kentucky, USA (2006-2014)"}}
# ggplot() +
#   geom_sf(data = KY, 
#           aes(fill = per_person, 
#               color = per_person)) + 
#   scale_fill_viridis(direction = -1, option = "B")+
#   scale_color_viridis(direction = -1, option ="B") +
#   #coord_sf(crs = 26915) + This crs is NAD83 UTM zone 15N - not really needed for plotting here but projecting the data may be required later
#   theme_void()+
#   theme(panel.grid.major = element_line(colour = 'transparent')) +
#   labs(caption="Source: The Washington Post, ARCOS") +
#   facet_wrap (~ year, ncol =2)
```

<!-- Similar to Figure \ref{fig:annual-dosage}, a nine-year average showing opioid use, of pills per person, for each county can be made (see Figure \ref{fig:mean-annual-dosage}). This provides a clearer distinction of changes in each county over the years in a single map, rather than several maps. -->

```{r calculate-annual-mean-dosage, include=FALSE}
KY_AVG_Per <- KY %>% 
  st_drop_geometry() %>%
  group_by(COUNTYFP) %>% # Group by county
  summarize(DOSAGE_UNIT = mean(DOSAGE_UNIT), # calculate the 9 year average `DOSAGE_UNIT` for every county
            per_person = mean(per_person)) %>% # calculate the 9 year average `per_person` for every county
  left_join(KY_shape, by = "COUNTYFP") %>% # join to the sf object
  st_as_sf() # convert to sf
```

```{r map-mean-per-person-dose, echo=FALSE, fig.cap={"\\label{fig:mean-annual-dosage}Mean annual opioid pills per person by county in Kentucky, USA (9-year average, 2006-2014)"}}
#Map the average dosage unit per person per year from 2006-2014.
# ggplot() +
#   geom_sf(data = KY_AVG_Per, 
#           aes(fill = per_person),
#           color = "white") + 
#   scale_fill_viridis(direction = -1, 
#                      option = "B", 
#                      name="Pills per capita") +
#   theme_void()+
#   theme(panel.grid.major = element_line(colour = 'transparent')) +
#   labs(caption="Source: The Washington Post, ARCOS") 
```

<!-- Figure \ref{fig:cartogram-mean-annual-dosage} is a cartogram showing regions with high usage of opioids. This cartogram emphasizes the highest changes in purchases in pills in each county over the selected nine years. -->
```{r create-cartogram, include=FALSE}
# KY_per_person_cartogram <- KY_AVG_Per %>%
#   st_transform(crs = 26916) %>%
#   cartogram_cont(weight = "per_person")
```

```{r map-per-person-dose-cartogram, echo=FALSE, fig.cap={"\\label{fig:cartogram-mean-annual-dosage}Cartogram of mean annual opioid pills per person by county in Kentucky, USA (9-year average, 2006-2014)"}}
# ggplot(KY_per_person_cartogram, aes(fill = per_person)) +
#   geom_sf(color = "white") + 
#   scale_fill_viridis(direction = -1, option = "B", name="Pills per Person")+
#   theme_void() +
#   theme(panel.grid.major = element_line(colour = 'transparent')) +
#   labs(caption="Source: The Washington Post, ARCOS")
```

<!-- Next, a series of maps were created; five choropleth maps with simulated spatial moving averages and a sixth with the empirical spatial moving averages. Figure \ref{fig:simulated-landscapes} is the original landscape of the average dosage unit per person compared to the five null landscapes. -->
```{r create-contiguities-object, include=FALSE}
# Create listw object
# KY_Pills.w <- KY_AVG_Per %>% 
#   as("Spatial") %>% 
#   poly2nb() %>%
#   nb2listw()
```

```{r calculate-spatial-moving-averages, include=FALSE}
# Observed data
# KY_AVG_Per <- KY_AVG_Per %>%
#   mutate(sma = lag.listw(KY_Pills.w, per_person))
# 
# # Null landscape/simulation #1
# simulation_1 <- sample(KY_AVG_Per$per_person)
# # Calculate spatial moving average
# simulation_1.sma <- lag.listw(KY_Pills.w, simulation_1)
# # Null landscape/simulation #2
# simulation_2 <- sample(KY_AVG_Per$per_person)
# simulation_2.sma <- lag.listw(KY_Pills.w, simulation_2)
# 
# # Null landscape/simulation #3
# simulation_3 <- sample(KY_AVG_Per$per_person)
# simulation_3.sma <- lag.listw(KY_Pills.w, simulation_3)
# 
# # Null landscape/simulation #4
# simulation_4 <- sample(KY_AVG_Per$per_person)
# simulation_4.sma <- lag.listw(KY_Pills.w, simulation_4)
# 
# # Null landscape/simulation #5
# simulation_5 <- sample(KY_AVG_Per$per_person)
# simulation_5.sma <- lag.listw(KY_Pills.w, simulation_5)
```

```{r add-simulated-landscapes, include=FALSE}
#Add simulated landscapes to sf dataframe
# KY_AVG_Per$simulation_1 <- simulation_1
# KY_AVG_Per$simulation_2 <- simulation_2
# KY_AVG_Per$simulation_3 <- simulation_3
# KY_AVG_Per$simulation_4 <- simulation_4
# KY_AVG_Per$simulation_5 <- simulation_5
# 
# #Add spatial moving averages to sf dataframe
# KY_AVG_Per$simulation_1.sma <- simulation_1.sma
# KY_AVG_Per$simulation_2.sma <- simulation_2.sma
# KY_AVG_Per$simulation_3.sma <- simulation_3.sma
# KY_AVG_Per$simulation_4.sma <- simulation_4.sma
# KY_AVG_Per$simulation_5.sma <- simulation_5.sma
```

```{r gather-simulated-landscapes, include=FALSE}
#Create a new dataframe to compare original landscape to null landscapes
# KY_AVG2 <- KY_AVG_Per %>% 
#   # `transmute()` keeps only the spatial moving averages and geometry
#   transmute(observed = per_person, 
#          simulation_1,
#          simulation_2,
#          simulation_3,
#          simulation_4,
#          simulation_5,
#          geometry) %>% 
#   # `pivot_longer()` places all variables with the exception of `geometry` in a single column named `SMA` and creates a new variable called `VAR` with the names of the original columns (i.e., observed, simulation_1,...)
#   pivot_longer(cols = -c(geometry, ends_with("sma")), names_to = "VAR", values_to = "values") %>%
#   st_as_sf()
```

```{r map-simulated-landscapes, echo=FALSE, fig.cap={"\\label{fig:simulated-landscapes}Maps showing the empirical distribution of mean annual opioid pills per person and five simulated landscapes"}}
# ggplot() + 
#   geom_sf(data = KY_AVG2, 
#           aes(fill = values), color = NA) + 
#   facet_wrap(~VAR, ncol = 3) +
#   scale_fill_viridis(direction = -1, option = "B")+
#   labs(fill = "Pills per SMA") + 
#   theme(axis.text.x = element_blank(), 
#         axis.text.y = element_blank())
```

<!-- By plotting the data of the spatial moving averages in Figure \ref{fig:simulated-landscapes}, the data can be further analyzed. The plots of the empirical and simulated spatial moving averages are shown in Figure \ref{fig:scatterplot-moving-averages}. -->

```{r gather-moving-averages-2, echo=FALSE}
# KY_AVG2 <- KY_AVG2 %>% 
#   data.frame(KY_AVG_Per %>% 
#                st_drop_geometry() %>% # Drop the geometry because it is already available 
#                # Select the original population density and the 5 null landscapes simulated from it.
#                transmute(sma,
#                       simulation_1.sma,
#                       simulation_2.sma,
#                       simulation_3.sma,
#                       simulation_4.sma,
#                       simulation_5.sma,
#                ) %>% # Pass the result to `pivot_longer()`  
#                pivot_longer(cols = everything(), names_to = "VAR", values_to = "SMA") %>% # Copy all density variables to a single column, and create a new variable called `VAR` with the names of the original columns 
#                select(SMA)) # Drop VAR from the the dataframe
```


```{r spatial-moving-averages, echo=FALSE, fig.cap={"\\label{fig:scatterplot-moving-averages}Moran's scatterplots of empirical and simulated spatial moving averages of mean annual opioid pills per person"}}
# ggplot(data = KY_AVG2, 
#        aes(x = values, 
#            y = SMA,
#            color = VAR)) +
#   geom_point(alpha = 0.1) +
#   geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
#   # Add a fitted line to the plots
#   geom_smooth(formula = y ~ x,
#               method = "lm") +
#   coord_equal() +
#   xlab("Pills per person") +
#   ylab("Spatial lag of pills per person") +
#   facet_wrap(~ VAR, ncol = 3)
```

```{r include=FALSE}
# KY_AVG_Per <- KY_AVG_Per %>% 
#   # Modify values in dataframe
#   mutate(Rate_z = per_person - mean(per_person), # Substract the mean, so that the variable now is deviations from the mean 
#          SMA_z = lag.listw(KY_Pills.w, Rate_z)) # Calculate the spatial moving average of the newly created variable `Density_z`
```


```{r moran-scatterplot, echo=FALSE, fig.cap={"\\label{fig:moran-scatterplot}Moran's scatterplot of empirical variable (observed)"}}
# Confirming the results from the Moran coefficient above. We use "moran.plot" to illustrate the SMA of rate by county
# mp <- moran.plot(KY_AVG_Per$per_person, 
#                  KY_Pills.w,
#                  xlab = "Pills per person",
#                  ylab = "Spatial lag of pills per person")
```

<!-- Figure \ref{fig:lisa} is a plot of the local indicators of spatial association (LISA), that is the local version of Moran's I. As seen in Moran's scatterplot (Figure \ref{fig:moran-scatterplot}), a county can have high levels of pills per capita (higher than the global mean), and be surrounded by counties that on average have high levels of pills per capita. This combination is termed "High-High". Another possibility is that a county has low levels of pills per capita (below the global mean), and the neighboring counties have also on average low levels of pills per capita. This combination is termed "Low-Low". The other two combinations are "High-Low" and "Low-High". Calculating the LISA allows us to categorize counties into one of these classes. Further, if we map these statistics we can visualize concentrations of high or low values, or transition zones. This type of map also makes it easy to visualize where a statistic is significant or not. It allows for easy analysis to detect _hot spots_, regions with high levels of pills per capita, or cold spots, regions with low levels of pills per capita. In Figure \ref{fig:lisa}, the statistic that can either be significant or not. -->

```{r lisa, include=FALSE}
# Per_person.lm <- localmoran(KY_AVG_Per$per_person, KY_Pills.w)
# summary(Per_person.lm)
```

```{r join-lisa-to-data, echo=FALSE}
# KY_AVG_Per <- left_join(KY_AVG_Per, 
#                         data.frame(GEOID = KY_AVG_Per$GEOID, 
#                                    Per_person.lm), 
#                         by = c("GEOID"))
# KY_AVG_Per <- rename(KY_AVG_Per, p.val = Pr.z...0.)
```

```{r lisa-map, echo = FALSE, fig.cap={"\\label{fig:lisa}Map of local statistics of spatial association, used to detect hot and cold spots"}}
# Now it is possible to map the local statistics:
#plot_ly(KY_AVG_Per) %>%
#  add_sf(split = ~(p.val < 0.05), color = ~Type, colors = c("red", "khaki1", "dodgerblue", "dodgerblue4")) 
# KY_AVG_Per %>%
#   mutate(significance = p.val <= 0.05,
#          Type = case_when((Rate_z >= 0 & SMA_z >= 0) & significance == TRUE ~ "HH significant",
#                           (Rate_z >= 0 & SMA_z >= 0) & significance == FALSE ~ "HH not significant",
#                           (Rate_z < 0 & SMA_z < 0) & significance == TRUE ~ "LL significant",
#                           (Rate_z < 0 & SMA_z < 0) & significance == FALSE ~ "LL not significant",
#                           (Rate_z * SMA_z < 0) & significance == TRUE ~ "HL/LH significant",
#                           (Rate_z * SMA_z < 0) & significance == FALSE ~ "HL/LH not significant"),
#          Type = factor(Type,
#                        levels = c("HH significant",
#                                   "HH not significant",
#                                   "HL/LH significant",
#                                   "HL/LH not significant",
#                                   "LL significant",
#                                   "LL not significant"))) %>%
#   ggplot() +
#   geom_sf(aes(fill = Type),
#           color = "gray80") + 
#   scale_fill_manual(values = c("HH significant" = "red", 
#                                "HH not significant" = "rosybrown1",
#                                "LL significant" = "dodgerblue",
#                                "LL not significant" = "lightblue",
#                                "HL/LH significant" = "gray",
#                                "HL/LH not significant" = "white")) +
#   theme_void() +
#   theme(panel.grid.major = element_line(colour = 'transparent'))
```

<!-- Figure \ref{fig:household-income} represents the mean annual household income in the counties in Kentucky. The darker the regions, the higher the yearly income. This map shows the general trend for income (2010) which is one of the variables that is used to analyze opioid usage in Kentucky. -->

```{r join-income-data, echo=FALSE}
# income_fip <- income_fip %>%  
#   rename(income = Mean) %>%
#   mutate(GEOID = as.character(GEOID))
# KY_AVG_Per <- KY_AVG_Per %>% 
#   left_join(income_fip,
#             by=("GEOID"))
```

```{r map-household-income, echo=FALSE, fig.cap={"\\label{fig:household-income}Mean annual household income in 2010"}}
# ggplot() +
#   geom_sf(data = KY_AVG_Per, 
#           aes(fill = income/10000),
#           color = "white") + 
#   scale_fill_viridis(direction = -1, 
#                      option = "B",
#                      name = "Mean household income ($10,000)") +
#   theme_void() +
#   theme(panel.grid.major = element_line(colour = 'transparent'),
#         legend.position = "bottom") +
#   labs(caption="Source: US Census Bureau")
```

<!-- The second variable that is analyzed with opioid usage is education. Figure \ref{fig:education} displays the percent of the population in each county who received a high school diploma by 2014. This data will also be compared to the opioid use of Kentucky. -->

```{r join-education-data, echo=FALSE}
# education_ky <- education_ky %>%  
#   mutate(GEOID = as.character(GEOID))
# 
# KY_AVG_Per <- KY_AVG_Per %>%
#   left_join(education_ky, 
#             by=("GEOID"))
```

```{r map-education-data, echo=FALSE, fig.cap={"\\label{fig:education}Educational attainment in Kentucky: percent of population with high school degree or higher (2014)"}}
# ggplot() +
#   geom_sf(data = KY_AVG_Per,
#           aes(fill = HSDeg),
#           color = "white") +
#   scale_fill_viridis(direction = -1, 
#                      option = "B",
#                      name = "% of population") +
#   theme_void() + 
#   theme(panel.grid.major = element_line(colour = 'transparent'),
#         legend.position = "bottom") +
#   labs(caption="Source: US Census Bureau")
```

<!-- To determine relationships between opioid use and the chosen variables, they must be regressed to the opioid use data. Figure 12 shows the average household income per county in Kentucky regressed to the number of opioid pills per person. Figure 13 shows the percent of the population per county that has obtained a high school degree regressed to the number of opioid pills per person. -->
```{r echo=FALSE}
#income_fip <- income_fip %>%  
#    mutate(GEOID = as.character(GEOID))
#KY_AVG_Per <- left_join(KY_AVG_Per, income_fip, by=("GEOID"))
```

\newpage

```{r model-income, echo=FALSE, message=FALSE, results="asis"}
# Use `lm()` to estimate a linear regression model
# model1 <- lm(formula = per_person ~ income, 
#              data = KY_AVG_Per)
# 
# # Use stargazer to print table with results of model
# stargazer(model1,
#           header = FALSE,
#           title = "Mean annual opioid pills per person regressed on mean household income")
```

```{r plot-model-income, echo = FALSE, fig.cap={"\\label{fig:model-income}Regression analysis of income and mean annual opioid pills per person"}}
# ggplot(data = KY_AVG_Per, 
#        aes(x = income, 
#            y = per_person))+
#   geom_point() +
#   geom_smooth(formula = y ~ x,
#               method = "lm") +
#   xlab("Mean annual household income") +
#   ylab("Pills per person")
```

\newpage

```{r model-education, echo=FALSE, message=FALSE, results="asis"}
# Use `lm()` to estimate a linear regression model
# model2 <- lm(formula = per_person ~ HSDeg,
#              data = KY_AVG_Per)
# 
# # Use stargazer to print table with results of model
# stargazer(model2,
#           header = FALSE,
#           title = "Mean annual opioid pills per person regressed on proportion of population with high school degree or higher")
```

```{r plot-model-education, echo=FALSE, fig.cap={"\\label{fig:model-education}Regression analysis of educational attainement and mean annual opioid pills per person"}}
# ggplot(data = KY_AVG_Per, 
#        aes(x = HSDeg, 
#            y = per_person))+
#   geom_point() +
#   geom_smooth(formula = y ~ x,
#               method = "lm") +
#   xlab("% population highschool or above") +
#   ylab("Pills per person") 
```

\newpage

<!-- These figures have been created to visualize and to show trends that might not be seen otherwise. General maps, choropleth maps, scatterplots and regression analyses were conducted to understand and find relationships between the use of opioids and income and/or education levels. -->

# Analysis

<!-- In Figure \ref{fig:annual-dosage}, we notice that the number of opioid pills per capita in Kentucky grew in the period between 2006 and 2014, as the colours appear darker in 2014 when compared to 2006. Regions with higher consumption of opioid pills remain high over the years, corresponding to the darker coloured regions remaining the darkest over time, on the south east of the state. Figure \ref{fig:mean-annual-dosage} illustrates that in the places with the highest levels of pills per capita over this period of time, so many pills were distributed that every person, every child, woman, and man in the county received more than 150 pills per year on average (and in some years more than this!). This does not mean that every single person in those counties was consuming almost three pills per week. But it does give a sobering indication of the flood of opioids that some counties faced. -->

<!-- From a spatial perspective, we are interested in learning whether the spatial pattern is random or not. Figure \ref{fig:simulated-landscapes} shows the distribution of the observed variable and five simulated (random) landscapes. It is clear from the figure that the map with the empirical variable is different from the simulated variables, suggesting that the average dosage unit per person is not random across the state. The highest average dosage units per person appear to be on the east side of Kentucky, followed by the west side and gradually decrease as we move towards the north-west.  -->

<!-- One of the advantages of the spatial moving average is its use in the development of scatterplots. Figure \ref{fig:scatterplot-moving-averages} represents the difference between the empirical and simulated variables along with the fitted regression line. In the figure, the slope of the line tends to be flat in the simulated variables, which is to be expected as these variables are null landscapes, and therefore spatially random. The empirical variable, on the other hand, has a slope that is closer to the 45-degree line than any of the simulated variables, suggesting that the values of the variable are not independent of their local mean, i.e., the probability of a non-random pattern is high.  -->

<!-- Figure \ref{fig:moran-scatterplot} repeats Moran's scatterplot of the average dosage unit per person per year from 2006 to 2014. The $p$-value of the Moran’s I calculation is very low. The null hypothesis of the spatial autocorrelation test is of spatial independence, and with a low $p$-value, this hypothesis can be rejected with a high degree of confidence. It is highly likely that there is a spatial pattern of opioid use in Kentucky. Some observations in the plot are highlighted, which means that they can be identified as “influential” since they make a particularly large contribution to decomposing Moran’s I. The relative contribution of each observation to the calculation of Moran’s I is informative by itself, and its analysis can provide more focused information about the spatial pattern. To understand the spatial pattern better, we calculate local statistics, which describe autocorrelation for a location of interest, as well as the contribution of that location to the global statistic.  -->

<!-- Figure \ref{fig:lisa} shows whether the average dosage unit per person in a zone is low, surrounded by zones that also have a low average dosage unit per person (LL) or high, surrounded by other zones with high average dosage units per person (HH). Other zones have either low average dosage units per person and are surrounded by zones with high average dosage units per person, or vice-versa (HL or LH). Therefore, it can be seen that there are significant hotspots of opioid distribution in the south and east of Kentucky, as well as a smaller cold spot in the north part of the state. -->

<!-- Having detected a spatial pattern, the next question was whether the pattern related to socio-economic or demographic attributes of the counties. We were particularly interested in the correlation between income and education and the distribution of opioids in Kentucky. -->

<!-- Figure \ref{fig:household-income} clearly shows that the highest income per household is mostly concentrated in the northern part of the state, where opioid distribution tended to be lower. Moving towards the east side the income seems to be gradually decreasing. This trend can be explained by the fact that educational attainment, shown in Figure \ref{fig:education}, is higher for the western counties and similar to the yearly income per household trend, for the most part, it decreases moving to the bottom, right area of the state.  -->

<!-- Figure \ref{fig:model-income} depicts a regression analysis of income. It shows a relationship between income and the number of pills per person. Even though there remains a fair amount of noise, represented by the dots around the regression line, the regression line captures the general trend of the data. Based on the plot, it can be seen that the counties with higher income per household seem to have lower numbers of pills per person. -->

<!-- Likewise, Figure \ref{fig:model-education}, which depicts a regression analysis of education, shows a relationship between the percentage of high-school-degree or above and pills per person. Here, the regression model appears to have less noise in comparison to the model of the regression analysis of income. The relationship between the variables, however, appears to have a similar trade to one of income. For example, the counties with a higher percentage of people with high school degrees and/or higher education seem to have slightly lower numbers of pills per person. -->

<!-- When comparing Figure \ref{fig:mean-annual-dosage}, which is the mean annual opioid distribution in Kentucky between 2006-2014 and Figure \ref{fig:model-income}, the mean yearly income Kentucky in 2010, the trend is that the lower the income, the higher the opioid use. There is a strong correlation between the two factors, income and opioid use. The highest opioid use in Kentucky in 2010, is located in the south-east counties, represented in the darkest colour (see \ref{fig:mean-annual-dosage}) and they correspond to lighter colours in \ref{fig:model-income}, where they are countries of lower mean yearly income. Thus, it can be determined that the lower the income, the higher the opioid use.  -->

<!-- When comparing Figure \ref{fig:mean-annual-dosage}, which is the mean annual opioid distribution in Kentucky between 2006-2014 and Figure \ref{fig:model-education}, which is the educational attainment in Kentucky in 2014, there is a weaker correlation between the factors as the majority of the population in Kentucky has a high school degree or above, making it harder to depict a pattern. The entire Kentucky region excluding the south-east counties has at least 80 percent of the population with high school degrees or above. Still, based on the data,  the lower the education level, the higher the opioid use. This trend is weaker because in the south-west region there is a high education level, but also a somewhat high opioid use.  -->

# Conclusion

<!-- Through the data processing methods used, patterns of spatial autocorrelation with opioid drug use in counties in Kentucky were revealed. This was shown by the low $p$-value in the Moran’s I test. A general pattern was found using the local Moran’s I statistic where counties in the north-west had a low number of pills per person surrounded by other counties with low opioid usage. In the south-east, there was a cluster of high opioid usage surrounded by counties with high opioid usage. Regression analysis determined that counties with a higher mean yearly income having lower opioid usage.  It also revealed that there is a higher percentage of people with high school degrees and/or higher educational attainment correlates with a slightly lower number of pills per person in that county.   -->

<!-- Having conducted the series of data analysis, it can be concluded that there is a causal relationship between education and income and opioid usage whereby increased education and income can result in less opioid usage and resulting consequences. However, it is recommended that further studies be conducted to confirm these trends with a high degree of accuracy. In addition, these studies could focus on the comparison between various states within the United States to further assess how states compare and where more resources should be allocated. -->

# References
311 Toronto (2019). Toronto District School Board Locations. Retrieved from 
  https://open.toronto.ca/dataset/toronto-district-school-board-locations/

CAA polling (2019). School Zone Safety Statistics. CAA. https://www.caa.ca/schoolzonesafety
	/statistics/

City Planning, City of Toronto (2021). Ward Profiles, 2014-2018 Wards. Retrieved
	from https://open.toronto.ca/dataset/ward-profiles-2014-2018-wards/

Information & Technology, City of Toronto (2021). Address Points (Municipal) - Toronto One 
  Address Repository. Retrieved from https://open.toronto.ca/dataset/address-points
  -municipal-toronto-one-address-repository/

Parachute (2016, June). Unintentional Injury Trends for Canadian Children. Retrieved from 
	https://parachute.ca/wp-content/uploads/2019/06/SKW-Trend-Report.pdf

Rocha, R., & Pelley, L. (2020, October 6). Toronto drivers speeding near schools 21% of the
  time, city data reveals. CBC. https://www.cbc.ca/news/canada/toronto/toronto-drivers
	-speeding-near-schools-21-of-the-time-city-data-reveals-1.5751299

Sun, D., El-Basyouny, K., Ibrahim, S., & Kim, A. M. (2018). Are school zones effective in 
	reducing speeds and improving safety? Canadian Journal of Civil Engineering, 45(12),
	1084–1092. https://doi.org/10.1139/cjce-2018-0060

Toronto Police Services (2020). Motor Vehicle Collisions involving Killed or Seriously
  Injured Persons. Retrieved from https://open.toronto.ca/dataset/motor-vehicle-collisions
  -involving-killed-or-seriously-injured-persons/

Transportation Services, City of Toronto (2020). School Safety Zone Watch Your Speed
	Program – Detailed Speed Counts. Retreived from https://open.toronto.ca/dataset
	/school-safety-zone-watch-your-speed-program-detailed-speed-counts/

Transportation Services, City of Toronto(2021). School Safety Zone Watch Your Speed Program 
  – Locations. Retrieved from https://open.toronto.ca/dataset/school-safety-zone-watch
	-your-speed-program-locations/

Transport Canada (2020, December 1). Canadian Motor Vehicle Traffic Collision Statistics: 
	2018. Government of Canada. https://tc.canada.ca/en/road-transportation/motor-vehicle
	-safety/canadian-motor-vehicle-traffic-collision-statistics-2018

